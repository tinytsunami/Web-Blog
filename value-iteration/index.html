<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#536F87">
<meta name="generator" content="Hexo 3.9.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/icon.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/icon.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#536F87">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">
  <link rel="stylesheet" href="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"www.tinytsunami.info","root":"/","scheme":"Gemini","version":"7.8.0","exturl":false,"sidebar":{"position":"right","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":true,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":true,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},"path":"search.xml"};
  </script>

  <meta name="description" content="這篇文章是《人工智能：一種現代的方法》及 Udacity 上的強化學習課程筆記及其他內容的整理，從馬可爾夫決策過程、價值迭代、策略迭代、Q 學習，最後到深度 Q 網路的思路。">
<meta name="keywords" content="技術, 獨立遊戲">
<meta property="og:type" content="article">
<meta property="og:title" content="價值迭代 Value Iteration">
<meta property="og:url" content="https://www.tinytsunami.info/value-iteration/index.html">
<meta property="og:site_name" content="羊羽手札">
<meta property="og:description" content="這篇文章是《人工智能：一種現代的方法》及 Udacity 上的強化學習課程筆記及其他內容的整理，從馬可爾夫決策過程、價值迭代、策略迭代、Q 學習，最後到深度 Q 網路的思路。">
<meta property="og:locale" content="zh-TW">
<meta property="og:image" content="https://i.imgur.com/8g4n6Sv.png">
<meta property="og:image" content="https://i.imgur.com/1Z7xib3.png">
<meta property="og:image" content="https://i.imgur.com/cpzMqL4.png">
<meta property="og:image" content="https://i.imgur.com/3LjuaW5.png">
<meta property="og:image" content="https://i.imgur.com/Jof8bqT.png">
<meta property="og:updated_time" content="2020-08-11T04:09:25.756Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="價值迭代 Value Iteration">
<meta name="twitter:description" content="這篇文章是《人工智能：一種現代的方法》及 Udacity 上的強化學習課程筆記及其他內容的整理，從馬可爾夫決策過程、價值迭代、策略迭代、Q 學習，最後到深度 Q 網路的思路。">
<meta name="twitter:image" content="https://i.imgur.com/8g4n6Sv.png">

<link rel="canonical" href="https://www.tinytsunami.info/value-iteration/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh-TW'
  };
</script>

  <title>價值迭代 Value Iteration | 羊羽手札</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="切換導航欄">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">羊羽手札</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">Tinytsunami's Blog</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
        <i class="fa fa-search fa-fw fa-lg"></i>
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>首頁</a>

  </li>
        <li class="menu-item menu-item-categories">

    <a href="/categories/" rel="section"><i class="fa fa-th fa-fw"></i>分類</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>歷程表</a>

  </li>
        <li class="menu-item menu-item-game">

    <a href="https://tinytsunami.itch.io/" rel="noopener" target="_blank"><i class="fas fa-gamepad fa-fw"></i>遊戲</a>

  </li>
      <li class="menu-item menu-item-search">
        <a role="button" class="popup-trigger"><i class="fa fa-search fa-fw"></i>搜尋
        </a>
      </li>
  </ul>
</nav>



  <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
  <span class="search-icon">
    <i class="fa fa-search"></i>
  </span>
  <div class="search-input-container">
    <input autocomplete="off" autocapitalize="off"
           placeholder="搜尋..." spellcheck="false"
           type="search" class="search-input">
  </div>
  <span class="popup-btn-close">
    <i class="fa fa-times-circle"></i>
  </span>
</div>
<div id="search-result">
  <div id="no-result">
    <i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>
  </div>
</div>

    </div>
  </div>

</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh-TW">
    <link itemprop="mainEntityOfPage" href="https://www.tinytsunami.info/value-iteration/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/head.jpg">
      <meta itemprop="name" content="Tinytusnami">
      <meta itemprop="description" content="羊羽的個人部落格">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="羊羽手札">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          價值迭代 Value Iteration
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">發表於</span>

              <time title="創建時間：2019-05-18 00:00:00" itemprop="dateCreated datePublished" datetime="2019-05-18T00:00:00Z">2019-05-18</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">更新於</span>
                <time title="修改時間：2020-08-11 04:09:25" itemprop="dateModified" datetime="2020-08-11T04:09:25Z">2020-08-11</time>
              </span>
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-folder"></i>
              </span>
              <span class="post-meta-item-text">分類於</span>
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/人工智慧/" itemprop="url" rel="index"><span itemprop="name">人工智慧</span></a>
                </span>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <p>這篇文章是《人工智能：一種現代的方法》及 Udacity 上的強化學習課程筆記及其他內容的整理，<br>從馬可爾夫決策過程、價值迭代、策略迭代、Q 學習，最後到深度 Q 網路的思路。<br><a id="more"></a></p>
<h1 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h1><p>這篇文章是上一篇文章《馬可爾夫決策過程 Markov Decision Process》的續篇，<br>如果沒有基礎或想看過那篇文章，可以先去看看。</p>
<div class="note success">
            <p>這是 DQN 的系列文章，上一篇是 <a href="/markov-decision-process/" title="馬可爾夫決策過程 Markov Decision Process">馬可爾夫決策過程 Markov Decision Process</a></p>
          </div>
<p>上一篇文章中，我們設計好了馬可爾夫決策過程的模型，但尚未提及如何解決問題。<br>為了解決序列式決策問題，本篇將會提到一個關鍵演算法「價值迭代」。</p>
<p>原本是要連策略迭代一起寫，結果價值迭代寫太長，後來決定分成兩篇了……</p>
<h1 id="問題建模"><a href="#問題建模" class="headerlink" title="問題建模"></a>問題建模</h1><p>為了避免讀者需要在兩個文章間不同切換，我在這邊簡單寫一些建模的內容，<br>當然符號方面也會跟上一篇文章差不多，但為了方便我們繼續討論下去，我們將做一些改變：</p>
<ul>
<li>地圖尋路及簡化二十一點的 $MOVE$ 跟 $ACTION$ 映射改成 $A$ 命名（A 表示動作，即 Action）</li>
<li>地圖尋路及簡化二十一點的 $POINT$ 跟 $SCORE$ 函數改成 $R$ 命名（R 表示回報，即 Reward）</li>
</ul>
<p>這樣一來文章讀起來比較順暢，再繼續之前，我們先重看一次建模的定義。</p>
<h2 id="地圖尋路"><a href="#地圖尋路" class="headerlink" title="地圖尋路"></a>地圖尋路</h2><p>請參考圖 1，問題定義寫在下方。</p>
<p><img src="https://i.imgur.com/8g4n6Sv.png" alt="圖 1、基本玩具問題"></p>
<p>問題建模為：</p>
<ul>
<li>狀態集合，即座標集合 $S = \{(x, y)| x \in \{1, 2, 3\}, y \in \{1, 2, 3, 4\} \}$</li>
<li>動作函數，即在某一座標可以執行的動作 $A: S \mapsto \{\text{up}, \text{left}, \text{right}, \text{down}\}$</li>
<li>轉移模型，即在某座標、執行某動作後，轉移到下個狀態的機率 $P(s_{t+1}|s_{t}, a_{t})$ 其中 $s_{t}, s_{t+1} \in S$ 且 $a_{t} \in A(s_{t})$</li>
<li>回報函數，每個位置的得分 $R(s) = R(x, y)$</li>
</ul>
<p>詳細定義的部分：</p>

$R(s) = R(x, y) = \left\{\begin{array}{l}
+1 && \text{if } s = (4, 3) \\
-1 && \text{if } s = (4, 2) \\
-0.04 && \text{otherwise}
\end{array}\right .$

<h2 id="簡化的二十一點"><a href="#簡化的二十一點" class="headerlink" title="簡化的二十一點"></a>簡化的二十一點</h2><p>前篇中，簡化二十一點的規則如下：</p>
<ul>
<li>牌面 1、2、3、4、5 每種牌都有無限多張且抽到每一種的機率相等</li>
<li>牌面 1、2、3、4、5 對應點數為牌面的數字</li>
<li>每一回合莊家、玩家決定要不要繼續抽牌</li>
<li>若某回合不抽牌，接下來的回合不能繼續抽牌</li>
<li>若超過 10 點，則判輸</li>
<li>若雙方皆超過 10 點，則平手</li>
<li>若雙方皆小於等於 10 點，則點數大者勝</li>
<li>所有牌都是明牌（玩家可觀察）</li>
<li>莊家先抽牌</li>
</ul>
<p>我們將其建模為：</p>
<ul>
<li>狀態集合，即各種手牌 $s$ 及允許抽牌標誌 $f$ 的集合 $S = \{s = (c, f) | c \subseteq \{1, 2, 3, 4, 5\},  f \in \{1, 0\}\}$</li>
<li>動作函數，即每回合可以執行的動作 $A: S \mapsto \{\text{draw}, \text{pass}\}$</li>
<li>轉移模型，即抽牌後，轉移到下個狀態的機率 $P(s_{t+1}|s_{t}, a_{t})$ 其中 $s_{t}, s_{t+1} \in S$ 且 $a_{t} \in A$</li>
<li>回報函數，即一局遊戲的牌面數字 $R(s)$ 其中 $s \in S$</li>
</ul>
<p>詳細定義的部分：</p>

$A(c, f) = \left\{\begin{array}{l}
\text{draw}, \text{pass} && \text{if } f = 1 \text{ and } \sum\limits_{x \in c}x \leq 10 \\
\text{pass} && \text{if }  f = 0 \text{ or } \sum\limits_{x \in c}x > 10 \\
\end{array}\right .$
<br><br>
$R(s) = R(c, f) = \left\{\begin{array}{l}
\sum\limits_{x \in c}x && \text{if } \sum\limits_{x \in c}x \leq 10 \\
0 && \text{if } \sum\limits_{x \in c}x > 10 \\
\end{array}\right .$
<br><br><div class="note warning">
            <p>再次提醒，這裡的動作函數 $A$ 很可能是「一對多」映射；嚴格說「一對多」映射不構成函數，但習慣上會這樣稱呼。</p>
          </div>
<h1 id="策略與效用"><a href="#策略與效用" class="headerlink" title="策略與效用"></a>策略與效用</h1><p>接下來，我們要討論策略與效用。</p>
<p>策略（policy）被定義為 $\pi(s_{t})$，其中 $s_{t} \in S$，指的是在狀態 $s_{t}$ 的情況下，推薦的行動，<br>行動通常是由 $A(s_{t})$ 一對多映射得到的「多種結果」，而 $\pi(s_{t})$ 會必然會給出其中一種。</p>
<p>為了對比，最優策略（best policy）通常表示為 $\pi^{*}(s_{t})$，<br>是理想狀態下可以得到的最佳決策，也是之後 AI 算法收斂的目標。</p>
<p>「效用」其實就是得分，為 $R(s_{t})$ 的加總。<br>若隨著時間我們有不同的狀態 $s_{0}, s_{1}, s_{2}, …$，則效用可以表示成：</p>
<p>$U_{h}([s_{0}, s_{1}, s_{2}, …]) = R(s_0) + \gamma R(s_1) + \gamma^{2} R(s_2) + …$</p>
<p>其中 $\gamma \in [0, 1]$ 為折扣因子，折扣因子越接近 $0$，則對未來的效用越不敏感，<br>通常這種效用的定義方式，被稱作折扣回報（discounted reward），<br>當 $\gamma = 1$ 效用退化成單純的加總，被稱為累加回報（addictive reward）。</p>
<h1 id="貝爾曼方程"><a href="#貝爾曼方程" class="headerlink" title="貝爾曼方程"></a>貝爾曼方程</h1><p>在進行算法前，我們這邊要介紹一個效用方程式，<br>被稱為「貝爾曼方程」又名動態規劃方程，定義如下：</p>
<p>$U(s_{t}) = R(s_{t}) + \gamma\max\limits_{a \in A(s_{t})}\sum\limits_{s_{t+1}}P(s_{t+1}|s_{t}, a)U(s_{t+1})$</p>
<p>回憶上面建模的定義，其中 $s_{t}, s_{t+1} \in S$ 且 $a_{t} \in A(s_{t})$</p>
<p>雖然看起來很複雜，但其實不太困難，具體來說：</p>
<ol>
<li>在某個時間 $t$ 有某一個狀態 $s_{t}$</li>
<li>這個 $s_{t}$ 的效用 $U(s_{t})$ 為「目前的效用 $R(s_{t})$」</li>
<li>執行某一個動作 $a$ 後，下一個狀態的期望值 $\sum\limits_{s_{t+1}}P(s_{t+1}|s_{t}, a)U(s_{t+1})$</li>
<li>這個狀態的效用，其中包含到折扣因子 $\gamma$ 及下一狀態期望的最佳效用</li>
</ol>
<p>其中第 3 點，單純這樣看可能難以理解；<br>因為抽牌具有隨機性，所以用我們的簡化二十一點說明：</p>
<ol>
<li>假設折扣因子為 $\gamma = 0.9$</li>
<li>舉例來說，在某個時間 $t$ 有某一個狀態 $s_{t} = (\{1, 3, 5\}, 1)$ 即「手牌有 1、3、5 點，還沒 PASS 過」</li>
<li>目前的效用 $R(s_{t}) = R(\{1, 3, 5\}, 1) = 1 + 3 + 5 = 9$</li>
<li>可以執行的動作為 $A(s_{t}) = A(c_{t}, f_{t}) = \text{draw, pass}$</li>
<li><p>執行抽牌動作 $a = \text{draw}$ 的話，期望值有：<br>$P((\{1, 3, 5, 1\}, 1)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 20\% \cdot U(s_{t+1}) = 20\% \cdot U(\{1, 3, 5, 1\}, 1) = 2$<br>（由於接下來 $s_{t+2}$ 都超過 10 點，選擇 PASS 為最大，所以不必計算 $U(s_{t+2})$ 的值。）<br>$P((\{1, 3, 5, 2\}, 1)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 20\% \cdot U(s_{t+1}) = 0$（超過 10 點）<br>$P((\{1, 3, 5, 3\}, 1)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 20\% \cdot U(s_{t+1}) = 0$（超過 10 點）<br>$P((\{1, 3, 5, 4\}, 1)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 20\% \cdot U(s_{t+1}) = 0$（超過 10 點）<br>$P((\{1, 3, 5, 5\}, 1)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 20\% \cdot U(s_{t+1}) = 0$（超過 10 點）<br>$P((\{1, 3, 5, 1\}, 0)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 20\% \cdot U(s_{t+1}) = 0$（再抽牌，超過 10 點）<br>$P((\{1, 3, 5, 2\}, 0)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 0\% \cdot U(s_{t+1}) = 0$（不能抽牌）<br>$P((\{1, 3, 5, 3\}, 0)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 0\% \cdot U(s_{t+1}) = 0$（不能抽牌）<br>$P((\{1, 3, 5, 4\}, 0)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 0\% \cdot U(s_{t+1}) = 0$（不能抽牌）<br>$P((\{1, 3, 5, 5\}, 0)|(\{1, 3, 5\}, 1), \text{draw})U(s_{t+1}) = 0\% \cdot U(s_{t+1}) = 0$（不能抽牌）</p>
</li>
<li><p>執行停止動作 $a = \text{pass}$ 的話，期望值有：<br>$P((\{1, 3, 5\}, 0)|(\{1, 3, 5\}, 1), \text{pass})U(s_{t+1}) = 100\% \cdot U(s_{t+1}) = 9$（接下來不能抽牌）<br>$P((\{1, 3, 5\}, 1)|(\{1, 3, 5\}, 1), \text{pass})U(s_{t+1}) = 0\% \cdot U(s_{t+1}) = 0$（PASS 後，能繼續抽牌的機率為 0）</p>
</li>
<li><p>則「最大的下一個狀態期望值」是 $\max\limits_{a \in A(s_{t})}\sum\limits_{s_{t+1}}P(s_{t+1}|s_{t}, a)U(s_{t+1}) = 9$</p>
</li>
<li><p>這個狀態的效用為 $U(s_{t}) = R(s_{t}) + \gamma\max\limits_{a \in A(s_{t})}\sum\limits_{s_{t+1}}P(s_{t+1}|s_{t}, a)U(s_{t+1}) = 9 + 0.9 \cdot 9 = 17.1$</p>
</li>
</ol>
<h1 id="價值迭代"><a href="#價值迭代" class="headerlink" title="價值迭代"></a>價值迭代</h1><p>有了效用的評估，我們可以計算每個狀態的效用，<br>然後利用效用來決策，這個過程稱為價值迭代（value iteration）。</p>
<p>下面為價值迭代的步驟：</p>
<ol>
<li>輸入變數：狀態集合 $S$、動作函數 $A(s)$、轉換模型 $P(s’|s, a)$、回報函數 $R$、折扣因子 $\gamma$與停止誤差 $\epsilon$</li>
<li>建立區域變數：初期效用 $U(s)$、暫存效用 $U’(s)$ 及效用差 $\delta$</li>
<li>$U \leftarrow U’$、$\delta \leftarrow 0$</li>
<li>$U’(s) \leftarrow R(s) + \gamma\max\limits_{a \in A(s)}\sum\limits_{s’}P(s’|s_{t}, a)U(s’), \forall s \in S$</li>
<li>若 $|U’(s) - U(s)| &gt; \delta$ 則 $\delta \leftarrow |U’(s) - U(s)|$</li>
<li>重複 3~5 步，直到 $\delta &lt; \epsilon (1 - \gamma) / \gamma$</li>
<li>回傳 $U$</li>
</ol>
<div class="note info">
            <p>其中 $s’$ 跟 $s_{t+1}$ 是相同的，指某狀態 $s$（或 $s_{t}$）的下一個可能狀態<br>但在迴圈中，避免讀者誤會 $t$ 會遞增，故改以 $s’$ 表示</p>
          </div>
<div class="note info">
            <p>$U$ 跟 $U’$ 是兩個大小為 $|S|$ 的向量</p>
          </div>
<p>不難發現，價值迭代不斷更新 $U(s)$ 向量去計算每個狀態的效用，<br>而中止條件是 $\delta &lt; \epsilon (1 - \gamma) / \gamma$ 其中 $\delta = \max\limits_{s}|U’(s) - U(s)|$</p>
<p>要理解終止條件，我們要來討論貝爾曼方程的收斂，先定義兩個內容：</p>
<ul>
<li>貝爾曼算子 $B$ 相當於執行 $R(s) + \gamma\max\limits_{a \in A(s)}\sum\limits_{s’}P(s’|s_{t}, a)U(s’)$</li>
<li>最大范數 $\|U\|=\max\limits_{s}|U(s)|$ 即向量中最大的值</li>
</ul>
<p>那麼，兩個效用的最大距離為 $\|U - U’\| = \max\limits_{s}|U’(s) - U(s)|$ 即演算法中的 $\delta$</p>
<p>接下來，考慮第 $t+1$ 次迭代的距離為 $\|U_{t+1} - U_{t+1}’\|$<br>考慮演算法中第 4 步，即 $U_{t+1} \leftarrow BU_{t}$，可以發現 $U_{t+1}$ 為 $BU_{t}$<br>故 $\|U_{t+1} - U_{t+1}’\| = \|BU_{t} - BU_{t}’\|$</p>
<p>因為 $\|BU_{t} - BU_{t}’\| = \|R(s) + \gamma\max\limits_{a \in A(s)}\sum\limits_{s’}P(s’|s_{t}, a)U_{t}(s’) - [R(s) + \gamma\max\limits_{a \in A(s)}\sum\limits_{s’}P(s’|s_{t}, a)U_{t}’(s’)]\|$<br>$= \|\gamma\max\limits_{a \in A(s)}\sum\limits_{s’}P(s’|s_{t}, a)U_{t}(s’) - \gamma\max\limits_{a \in A(s)}\sum\limits_{s’}P(s’|s_{t}, a)U_{t}’(s’)\|$<br>$= \gamma \|\max\limits_{a \in A(s)}\sum\limits_{s’}P(s’|s_{t}, a)U_{t}(s’) - \max\limits_{a \in A(s)}\sum\limits_{s’}P(s’|s_{t}, a)U_{t}’(s’)\|$<br>$\leq \gamma \|\max\limits_{s}U_{t}(s’) - \max\limits_{s}U_{t}’(s’)\|$<br>（「選擇某個動作達到的最大效用」不會高於「遍歷所有狀態得到的最大效用」）</p>
<p>簡單觀察 $|\max\limits_{a}f(a) - \max\limits_{a}g(a)| \leq \max\limits_{a}|f(a) - g(a)|$<br>在 $\max\limits_{a}|f(a) - g(a)|$ 中，若 $f(a)$ 為最大值，即 $f(a) = \max\limits_{a}f(a)$<br>同樣的 $a$ 對於 $g(a)$ 來說，可能不滿足 $g(a) = \max\limits_{a}g(a)$，所以有上面那個結果（書中習題 17.6(a) 的內容）</p>
<p>又 $\|U - U’\| = \max\limits_{s}|U’(s) - U(s)|$<br>所以 $\|BU_{t} - BU_{t}’\| \leq \gamma \|\max\limits_{s}U_{t}(s’) - \max\limits_{s}U_{t}’(s’)\| \leq \max\limits_{s}|U’(s) - U(s)| = \|U - U’\|$<br>可得 $\|BU_{t} - BU_{t}’\| \leq |U_{t} - U_{t}’|$</p>
<p>考慮效用的極值：<br>$U_{h}([s_{0}, s_{1}, s_{2}, …]) = R(s_0) + \gamma R(s_1) + \gamma^{2} R(s_2) + …$<br>$\leq \max\limits_{s}R(s) + \gamma \max\limits_{s}R(s) + \gamma^{2} \max\limits_{s}R(s) + … = \frac{\max\limits_{s}R(s)}{1-\gamma}$（由於 $\gamma &lt; 1$ 使用等比級數公式）</p>
<p>若有負回報 $R(s) \leq 0$ 同理，則有 $U_{max} = \pm\frac{\max\limits_{s}R(s)}{1-\gamma}$</p>
<div class="note info">
            <p>這個步驟透漏了一個訊息，當 $\gamma = 1$ 時，很可能貝爾曼方程不會收斂。</p>
          </div>
<p>透過最大、小值範圍，不難推導出 $\|U_{0} - U_{t}’\| \leq \frac{2\max\limits_{s}R(s)}{1-\gamma}$<br>若 $N$ 次迭代的誤差不超過 $\epsilon$，又每一次誤差降低 $\gamma$ 倍，則 $\gamma^{N}\frac{2\max\limits_{s}R(s)}{1-\gamma}\leq \epsilon$</p>
<p>解出 $N$：<br>$\gamma^{N}\frac{2\max\limits_{s}R(s)}{1-\gamma}\leq \epsilon$<br>$\gamma^{N}2\max\limits_{s}R(s) \leq \epsilon(1-\gamma)$<br>$\gamma^{N} \leq \frac{\epsilon(1-\gamma)}{2\max\limits_{s}R(s)}$<br>$N \leq log_{\gamma}(\frac{\epsilon(1-\gamma)}{2\max\limits_{s}R(s)})$<br>$N \leq log(\frac{\epsilon(1-\gamma)}{2\max\limits_{s}R(s)})/log(\gamma)$（換底公式）</p>
<p>則 $N$ 至多迭代 $\lceil log(\frac{\epsilon(1-\gamma)}{2\max\limits_{s}R(s)})/log(\gamma) \rceil$ 次，<br>這是一整個系統的迭代上界，若我們只考慮一步：</p>
<p>$\gamma\frac{2\max\limits_{s}R(s)}{1-\gamma}\leq \epsilon$<br>$2\gamma\max\limits_{s}R(s) \leq \epsilon(1-\gamma)$<br>$2\max\limits_{s}R(s) \leq \frac{\epsilon(1-\gamma)}{\gamma}$</p>
<p>另外由於 $\|U_{t+1} - U_{t}\| = \|U_{t} - U_{t+1}\| \leq \|U_{0} - U_{t}’\| $<br>所以 $\|U_{t+1} - U_{t}\| \leq \|U_{0} - U_{t}’\| \leq 2\max\limits_{s}R(s) \leq \frac{\epsilon(1-\gamma)}{\gamma}$<br>可得 $\|U_{t+1} - U_{t}\| = \max\limits_{s}|U’(s) - U(s)| = \delta \leq \frac{\epsilon(1-\gamma)}{\gamma}$ 為中止條件</p>
<h1 id="問題解決"><a href="#問題解決" class="headerlink" title="問題解決"></a>問題解決</h1><p>接下來，我們來看實際解決問題時，價值迭代是如何運作的，<br>雖然表面上價值迭代計算每個狀態的效用，然後選擇動作朝著效用較大的方向前進，<br>但有時狀態顯示的效用並不能協助我們做出較佳的決策。</p>
<h2 id="地圖巡路"><a href="#地圖巡路" class="headerlink" title="地圖巡路"></a>地圖巡路</h2><p>這是書中玩具問題，再加上一點修改而成；<br>具體來說，我們的移動是確定的，導致期望值的部分是確定的。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">/* 宣告變數 */</span></span><br><span class="line"><span class="keyword">const</span> up = <span class="number">0</span>, down = <span class="number">1</span>, left = <span class="number">2</span>, right = <span class="number">3</span>;</span><br><span class="line"><span class="keyword">let</span> A = [up, down, left, right];                        <span class="comment">// 動作 A</span></span><br><span class="line"><span class="keyword">let</span> U = <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">3</span>&#125;, () =&gt;                   <span class="comment">// 效用</span></span><br><span class="line">        <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">4</span>&#125;, () =&gt; <span class="number">0</span>));              <span class="comment">// 大小 width = 4, height = 3</span></span><br><span class="line"><span class="keyword">let</span> Ut = <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">3</span>&#125;, () =&gt;                  <span class="comment">// 效用暫存</span></span><br><span class="line">         <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">4</span>&#125;, () =&gt; <span class="number">0</span>));             <span class="comment">// 大小同效用 U</span></span><br><span class="line"><span class="keyword">let</span> D = <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">3</span>&#125;, () =&gt;                   <span class="comment">// 決策表</span></span><br><span class="line">         <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">4</span>&#125;, () =&gt; <span class="number">0</span>));             <span class="comment">// 大小同效用 U</span></span><br><span class="line"><span class="keyword">let</span> epsilon = <span class="number">0.01</span>;                                     <span class="comment">// 迭代停止參數</span></span><br><span class="line"><span class="keyword">let</span> gamma = <span class="number">0.9</span>;                                        <span class="comment">// 折扣因子</span></span><br><span class="line"><span class="keyword">let</span> delta;                                              <span class="comment">// 迭代差</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 回報函數 */</span></span><br><span class="line"><span class="keyword">let</span> R = <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">if</span>(x == <span class="number">3</span> &amp;&amp; y == <span class="number">0</span>) &#123;                                <span class="comment">// 終點</span></span><br><span class="line">    <span class="keyword">return</span> +<span class="number">1</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(x == <span class="number">3</span> &amp;&amp; y == <span class="number">1</span>) &#123;                          <span class="comment">// 陷阱</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">-1</span>;</span><br><span class="line">  &#125;<span class="keyword">else</span> <span class="keyword">if</span>(x == <span class="number">1</span> &amp;&amp; y == <span class="number">1</span>) &#123;                          <span class="comment">// 牆（不評分）</span></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="number">-0.04</span>;                                         <span class="comment">// 其他狀態</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 動作的期望值 */</span></span><br><span class="line"><span class="keyword">let</span> Exp = <span class="function"><span class="keyword">function</span>(<span class="params">x, y</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> exp = [];</span><br><span class="line">  <span class="keyword">if</span>(x &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    exp.push(<span class="number">1.0</span> * U[y][x - <span class="number">1</span>]);                        <span class="comment">// 向左移動</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(x &lt; <span class="number">3</span>) &#123;</span><br><span class="line">    exp.push(<span class="number">1.0</span> * U[y][x + <span class="number">1</span>]);                        <span class="comment">// 向右移動</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(y &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    exp.push(<span class="number">1.0</span> * U[y - <span class="number">1</span>][x]);                        <span class="comment">// 向上移動</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span>(y &lt; <span class="number">2</span>) &#123;</span><br><span class="line">    exp.push(<span class="number">1.0</span> * U[y + <span class="number">1</span>][x]);                        <span class="comment">// 向下移動</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> exp;                                           <span class="comment">// 回傳期望值</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 演算法主體 */</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="number">3</span>; y++) &#123;                         <span class="comment">// 複製效用暫存</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="number">4</span>; x++) &#123;</span><br><span class="line">      U[y][x] = Ut[y][x];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  delta = <span class="number">0</span>;                                            <span class="comment">// 初始化迭代差</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> y = <span class="number">0</span>; y &lt; <span class="number">3</span>; y++) &#123;                         <span class="comment">// 對所有狀態</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> x = <span class="number">0</span>; x &lt; <span class="number">4</span>; x++) &#123;  </span><br><span class="line">      <span class="keyword">if</span>((x == <span class="number">3</span> &amp;&amp; y == <span class="number">0</span>) ||                          <span class="comment">// 終點的效用固定</span></span><br><span class="line">         (x == <span class="number">3</span> &amp;&amp; y == <span class="number">1</span>) ||                          <span class="comment">// 陷阱的效用固定</span></span><br><span class="line">         (x == <span class="number">1</span> &amp;&amp; y == <span class="number">1</span>)) &#123;                          <span class="comment">// 牆的效用固定</span></span><br><span class="line">        Ut[y][x] = R(x, y);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">else</span> &#123;                                            <span class="comment">// 其他狀態的效用</span></span><br><span class="line">        <span class="keyword">let</span> exp = Exp(x, y);</span><br><span class="line">        Ut[y][x] = R(x, y) + gamma * <span class="built_in">Math</span>.max(...exp);  <span class="comment">// 貝爾曼方程</span></span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(Ut[y][x] - U[y][x]) &gt; delta) &#123;       <span class="comment">// 計算最大迭代差</span></span><br><span class="line">        delta = <span class="built_in">Math</span>.abs(Ut[y][x] - U[y][x]);           <span class="comment">// 儲存迭代差</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (delta &gt;= epsilon * (<span class="number">1</span> - gamma) / gamma);       <span class="comment">// 中止條件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 在 Console 輸出表格 */</span></span><br><span class="line"><span class="built_in">console</span>.table(U);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>程式輸出請參考圖 2 所示，<br>雖然表面上，只要沿著效用較大的格子走，就可以到達終點，<br>但實際的決策可能要參考 $\max\limits_{a \in A(s)}$ 的動作選擇，<br>具體請參考簡化二十一點的程式輸出。</p>
<p><img src="https://i.imgur.com/1Z7xib3.png" alt="圖 2、地圖巡路：程式輸出"></p>
<h2 id="簡化二十一點"><a href="#簡化二十一點" class="headerlink" title="簡化二十一點"></a>簡化二十一點</h2><p>接著看我們自己設計的玩具問題，幫助我們理解更全面一點。</p>
<p>考慮任何狀態 $s_{t} = (c, f) \in S$ 與 $s_{t}’ = (c’, f’) \in S$<br>若滿足 $\sum\limits_{x \in c}x = \sum\limits_{x \in c’}x$ 則效用評估有：$U(s_{t}) = U(s_{t}’)$<br>因為效用等於牌面點數和 $R(s) = R(s’)$，而動作只有抽不抽牌，故雖然看起來 $|S|$ 很大，<br>但其實 $|S|$ 有意義的範圍，只有 $\sum\limits_{x \in c}x \leq 10$ 的部分而已。</p>
<p>故 $S$ 大小為總和的可能值域：即 0（手上沒牌）到 15（剛好手上總和為 10 點時，又抽了一張 5 點）<br>加上抽不抽牌的旗標有 0 與 1 兩種，共 2*15 = 30 種狀態，<br>然而實際程式碼中，狀態其實只是效用 $U$ 與 $U’$ 的引索而已。</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br></pre></td><td class="code"><pre><span class="line">...</span><br><span class="line"><span class="comment">/* 宣告變數 */</span></span><br><span class="line"><span class="keyword">const</span> pass = <span class="number">0</span>, draw = <span class="number">1</span>;                               <span class="comment">// 動作 A</span></span><br><span class="line"><span class="keyword">let</span> U = <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">2</span>&#125;, () =&gt;                   <span class="comment">// 效用, s = (c, f)</span></span><br><span class="line">        <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">16</span>&#125;, () =&gt; <span class="number">0</span>));             <span class="comment">// 大小 |c| = 16, |f| = 2 </span></span><br><span class="line"><span class="keyword">let</span> Ut = <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">2</span>&#125;, () =&gt;                  <span class="comment">// 效用暫存</span></span><br><span class="line">         <span class="built_in">Array</span>.from(&#123;<span class="attr">length</span>: <span class="number">16</span>&#125;, () =&gt; <span class="number">0</span>));            <span class="comment">// 大小同效用 U</span></span><br><span class="line"><span class="keyword">let</span> epsilon = <span class="number">0.01</span>;                                     <span class="comment">// 迭代停止參數</span></span><br><span class="line"><span class="keyword">let</span> gamma = <span class="number">0.9</span>;                                        <span class="comment">// 折扣因子</span></span><br><span class="line"><span class="keyword">let</span> delta;                                              <span class="comment">// 迭代差</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 回報函數 */</span></span><br><span class="line"><span class="keyword">let</span> R = <span class="function"><span class="keyword">function</span>(<span class="params">c</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> c &gt; <span class="number">10</span> ? <span class="number">0</span> : c;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 動作的期望值</span></span><br><span class="line"><span class="comment">   若 f = 0: 只能選擇 "pass" (其中 exp = [pass_value])</span></span><br><span class="line"><span class="comment">   若 f = 1: 可能選擇 "draw" 或 "pass" (其中 exp = [pass_value, draw_value]) */</span></span><br><span class="line"><span class="keyword">let</span> Exp = <span class="function"><span class="keyword">function</span>(<span class="params">c, f</span>) </span>&#123;</span><br><span class="line">  <span class="keyword">let</span> exp = [];</span><br><span class="line">  <span class="keyword">if</span> (f == <span class="number">0</span>) &#123;                                         <span class="comment">// 若 f = 0: 只能選 "pass"</span></span><br><span class="line">    exp.push(<span class="number">1.0</span> * R(c));                               <span class="comment">// pass 成功機率為 100%</span></span><br><span class="line">  &#125; <span class="keyword">else</span> <span class="keyword">if</span> (f == <span class="number">1</span>) &#123;                                  <span class="comment">// 若 f = 1: 能選 pass 或 draw</span></span><br><span class="line">    exp.push(<span class="number">1.0</span> * R(c));                               <span class="comment">// pass 成功機率為 100%</span></span><br><span class="line">    <span class="keyword">let</span> t = <span class="number">0</span>;                                          <span class="comment">// draw 下個狀態的機率為牌面 + 1~5 (各20%)</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> d = <span class="number">1</span>; d &lt;= <span class="number">5</span>; d++) &#123;</span><br><span class="line">      <span class="keyword">if</span> (c + d &lt; <span class="number">16</span>) &#123;</span><br><span class="line">        t += <span class="number">0.2</span> * U[f][c + d];</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    exp.push(t);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> exp;                                           <span class="comment">// 回傳期望值</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/* 演算法主體 */</span></span><br><span class="line"><span class="keyword">do</span> &#123;</span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> f = <span class="number">0</span>; f &lt;= <span class="number">1</span>; f++) &#123;                        <span class="comment">// 複製效用暫存</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> c = <span class="number">0</span>; c &lt;= <span class="number">15</span>; c++) &#123;</span><br><span class="line">      U[f][c] = Ut[f][c];</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  delta = <span class="number">0</span>;                                            <span class="comment">// 初始化迭代差</span></span><br><span class="line">  <span class="keyword">for</span> (<span class="keyword">let</span> f = <span class="number">0</span>; f &lt;= <span class="number">1</span>; f++) &#123;                        <span class="comment">// 對所有狀態 s = (c, f)</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="keyword">let</span> c = <span class="number">0</span>; c &lt;= <span class="number">15</span>; c++) &#123;</span><br><span class="line">      <span class="keyword">let</span> exp = Exp(c, f);</span><br><span class="line">      Ut[f][c] = R(c) + gamma * <span class="built_in">Math</span>.max(...exp);       <span class="comment">// 貝爾曼方程</span></span><br><span class="line">      <span class="keyword">if</span> (<span class="built_in">Math</span>.abs(Ut[f][c] - U[f][c]) &gt; delta) &#123;       <span class="comment">// 計算最大迭代差</span></span><br><span class="line">        delta = <span class="built_in">Math</span>.abs(Ut[f][c] - U[f][c]);           <span class="comment">// 儲存迭代差</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125; <span class="keyword">while</span> (delta &gt;= epsilon * (<span class="number">1</span> - gamma) / gamma);       <span class="comment">// 中止條件</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* 在 Console 輸出表格 */</span></span><br><span class="line"><span class="keyword">let</span> arr = [[], []];</span><br><span class="line"><span class="keyword">for</span>(<span class="keyword">let</span> c = <span class="number">0</span>; c &lt;= <span class="number">15</span>; c++) &#123;</span><br><span class="line">    arr[<span class="number">0</span>].push(<span class="built_in">parseFloat</span>(U[<span class="number">0</span>][c].toFixed(<span class="number">2</span>)));</span><br><span class="line">    arr[<span class="number">1</span>].push(<span class="built_in">parseFloat</span>(U[<span class="number">1</span>][c].toFixed(<span class="number">2</span>)));</span><br><span class="line">&#125;</span><br><span class="line"><span class="built_in">console</span>.table(arr);</span><br><span class="line">...</span><br></pre></td></tr></table></figure>
<p>參考圖 3 可以看到執行結果，<br>查看完整演示之前，我們可能需要分析一下結果的合理性。</p>
<p><img src="https://i.imgur.com/cpzMqL4.png" alt="圖 3、簡化二十一點：程式輸出"></p>
<p>若狀態 $s = (c, f)$，那麼列（row）方向是 $f$ 的標誌，而行（cloumn）方向是 $\sum\limits_{x \in c}x$ 的值。</p>
<p>可以發現 $s = (9, 1)$ 的值，跟 <a href="#貝爾曼方程">貝爾曼方程段落</a> 的手算結果一致，<br>不過看起來表格怪怪的，這主要是因為我們沒有顯式地把 $\max\limits_{a \in A(s)}$ 的選擇保留，<br>導致這張表格本身雖然能看到效用值 $U$，但是不能為我們做決策。</p>
<p>舉兩個例來說：</p>
<ol>
<li><p>如果我狀態在 $s = (1, 10)$ 則我會選擇 $s = (0, 10)$ 為下個狀態（也就是 pass 動作），<br>因為與 $(1, i), i = 11, 12, …, 15$ 相比，該位置效用值較大。</p>
</li>
<li><p>如果我狀態在 $s = (1, 9)$ 則我會選擇 $s = (1, 10)$ 為下個狀態（也就是 draw 動作），<br>因為與 $(1, i), i = 10, 12, …, 14$ 相比，該位置效用值較大。</p>
</li>
</ol>
<p>第二個例子，就是這張表不合邏輯的地方了，<br>從另一個角度來說，如果我狀態是 $s = (1, 9)$，抽牌的風險非常大。</p>
<div class="note info">
            <p>敏銳的讀者可能發現，可以將這個玩具問題轉換成地圖尋路。</p>
          </div>
<h3 id="結果修正"><a href="#結果修正" class="headerlink" title="結果修正"></a>結果修正</h3><p>事實上，如果我們將 $\max\limits_{a \in A(s)}$ 記錄下來，可以發現 AI 其實是選擇 pass 動作，才使效用最大化的，<br>具體參考圖 4 的 $s = (1, 9)$ 處。</p>
<p><img src="https://i.imgur.com/3LjuaW5.png" alt="圖 4、簡化二十一點：MAX 函數的動作選擇"></p>
<p>題外話，若改變 $R(s)$ 在 $\sum\limits_{x \in c}x &gt; 10$ 條件下的值，決策可能發生變化；<br>具體來說，當 $0$ 變成 $-\infty$ 時，決策會趨近絕對保守（盡量 PASS），反之亦然。</p>
<p>另一個修正方法是，將 $R(s)$ 重新定義，順便將 $(1, i), i = 11, 12, …, 15$ 固定下來。<br>我們規定，狀態為 $pass$ 時，會有回報的加成，則重新定義的 $R$ 為：</p>

$R(s) = R(c, f) = \left\{\begin{array}{l}
(1 - f) + \sum\limits_{x \in c}x && \text{if } \sum\limits_{x \in c}x \leq 10\\
0 && \text{if } \sum\limits_{x \in c}x > 10\\
\end{array}\right .$

<p>結果請參考圖 5，此時我們便可以透過效用直接選擇動作了。</p>
<p><img src="https://i.imgur.com/Jof8bqT.png" alt="圖 5、簡化二十一點：重新定義回報的結果"></p>
<h3 id="演示"><a href="#演示" class="headerlink" title="演示"></a>演示</h3><iframe scrolling="no" width="100%" height="200px" src="//jsfiddle.net/bzL638xf/embedded/result,js,html,css/dark" frameborder="0" allowfullscreen></iframe>
<div class="note info">
            <p>雖然邏輯上是 AI 高於 7 點則不再抽牌，但這個結論是透過計算而來的；<br>可以想見在更複雜的狀態環境中，仍可建立決策模式。</p>
          </div>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/sheeps-02/" rel="prev" title="羊與羊的草原 02">
      <i class="fa fa-chevron-left"></i> 羊與羊的草原 02
    </a></div>
      <div class="post-nav-item">
    <a href="/sheeps-03/" rel="next" title="羊與羊的草原 03">
      羊與羊的草原 03 <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          
    <div class="comments" id="gitalk-container"></div>

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          文章目錄
        </li>
        <li class="sidebar-nav-overview">
          本站概要
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#前言"><span class="nav-number">1.</span> <span class="nav-text">前言</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#問題建模"><span class="nav-number">2.</span> <span class="nav-text">問題建模</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#地圖尋路"><span class="nav-number">2.1.</span> <span class="nav-text">地圖尋路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#簡化的二十一點"><span class="nav-number">2.2.</span> <span class="nav-text">簡化的二十一點</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#策略與效用"><span class="nav-number">3.</span> <span class="nav-text">策略與效用</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#貝爾曼方程"><span class="nav-number">4.</span> <span class="nav-text">貝爾曼方程</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#價值迭代"><span class="nav-number">5.</span> <span class="nav-text">價值迭代</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#問題解決"><span class="nav-number">6.</span> <span class="nav-text">問題解決</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#地圖巡路"><span class="nav-number">6.1.</span> <span class="nav-text">地圖巡路</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#簡化二十一點"><span class="nav-number">6.2.</span> <span class="nav-text">簡化二十一點</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#結果修正"><span class="nav-number">6.2.1.</span> <span class="nav-text">結果修正</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#演示"><span class="nav-number">6.2.2.</span> <span class="nav-text">演示</span></a></li></ol></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <img class="site-author-image" itemprop="image" alt="Tinytusnami"
      src="/images/head.jpg">
  <p class="site-author-name" itemprop="name">Tinytusnami</p>
  <div class="site-description" itemprop="description">羊羽的個人部落格</div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">40</span>
          <span class="site-state-item-name">文章</span>
        </a>
      </div>
      <div class="site-state-item site-state-categories">
            <a href="/categories/">
          
        <span class="site-state-item-count">15</span>
        <span class="site-state-item-name">分類</span></a>
      </div>
  </nav>
</div>
  <div class="links-of-author motion-element">
      <span class="links-of-author-item">
        <a href="https://github.com/tinytsunami" title="GitHub → https://github.com/tinytsunami" rel="noopener" target="_blank"><i class="fab fa-github fa-fw"></i>GitHub</a>
      </span>
      <span class="links-of-author-item">
        <a href="mailto:z27619273@gmail.com" title="E-Mail → mailto:z27619273@gmail.com" rel="noopener" target="_blank"><i class="fa fa-envelope fa-fw"></i>E-Mail</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.facebook.com/profile.php?id=100000736195394" title="FB Page → https://www.facebook.com/profile.php?id=100000736195394" rel="noopener" target="_blank"><i class="fab fa-facebook fa-fw"></i>FB Page</a>
      </span>
      <span class="links-of-author-item">
        <a href="https://www.youtube.com/channel/UCtqp9w_uA_LohDm0YXNWqSA" title="YouTube → https://www.youtube.com/channel/UCtqp9w_uA_LohDm0YXNWqSA" rel="noopener" target="_blank"><i class="fab fa-youtube fa-fw"></i>YouTube</a>
      </span>
  </div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 2018 – 
  <span itemprop="copyrightYear">2020</span>
  <span class="with-love">
    <i class="fa fa-bomb"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Tinytusnami</span>
</div>
  <div class="powered-by">由 <a href="https://hexo.io" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://theme-next.org" class="theme-link" rel="noopener" target="_blank">NexT.Gemini</a> 強力驅動
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="//cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script>
  <script src="//cdn.jsdelivr.net/gh/fancyapps/fancybox@3/dist/jquery.fancybox.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>
<script src="/js/utils.js"></script><script src="/js/motion.js"></script>
<script src="/js/schemes/pisces.js"></script>
<script src="/js/next-boot.js"></script>



  




  <script src="/js/local-search.js"></script>












  

  
      

<script>
  if (typeof MathJax === 'undefined') {
    window.MathJax = {
      loader: {
        source: {
          '[tex]/amsCd': '[tex]/amscd',
          '[tex]/AMScd': '[tex]/amscd'
        }
      },
      tex: {
        inlineMath: {'[+]': [['$', '$']]},
        tags: 'ams'
      },
      options: {
        renderActions: {
          findScript: [10, doc => {
            document.querySelectorAll('script[type^="math/tex"]').forEach(node => {
              const display = !!node.type.match(/; *mode=display/);
              const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display);
              const text = document.createTextNode('');
              node.parentNode.replaceChild(text, node);
              math.start = {node: text, delim: '', n: 0};
              math.end = {node: text, delim: '', n: 0};
              doc.math.push(math);
            });
          }, '', false],
          insertedScript: [200, () => {
            document.querySelectorAll('mjx-container').forEach(node => {
              let target = node.parentNode;
              if (target.nodeName.toLowerCase() === 'li') {
                target.parentNode.classList.add('has-jax');
              }
            });
          }, '', false]
        }
      }
    };
    (function () {
      var script = document.createElement('script');
      script.src = '//cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js';
      script.defer = true;
      document.head.appendChild(script);
    })();
  } else {
    MathJax.startup.document.state(0);
    MathJax.texReset();
    MathJax.typeset();
  }
</script>

    

  

<link rel="stylesheet" href="//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.css">

<script>
NexT.utils.loadComments(document.querySelector('#gitalk-container'), () => {
  NexT.utils.getScript('//cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js', () => {
    var gitalk = new Gitalk({
      clientID    : '8b224f954e247f37ca81',
      clientSecret: '36ffe64406d0cfaa8d1811ebf27c58638876fc8d',
      repo        : 'tinytsunami.github.io',
      owner       : 'tinytsunami',
      admin       : ['tinytsunami'],
      id          : 'd900a57f1ea0b4d98c8726027585173a',
        language: 'zh-TW',
      distractionFreeMode: true
    });
    gitalk.render('gitalk-container');
  }, window.Gitalk);
});
</script>

</body>
</html>
